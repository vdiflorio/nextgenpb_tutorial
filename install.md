
# üõ†Ô∏è Installation Guide for NextGenPB

----

This section provides a comprehensive guide to installing **NextGenPB**, including all required libraries and setup instructions for **macOS**, **Linux**, and **containerized environments**.

## üì¶ Dependencies
NextGenPB relies on several libraries and tools for building, executing, and post-processing results.

### Core Libraries
These libraries are mandatory to compile and execute NextGenPB:

- **`lis`** - A lightweight iterative solver library
- **`p4est`** - Parallel forest-of-octrees library for AMR
- **`bim++`**  - Custom library for FEM support
- **`NanoShaper`**  - Used for generating molecular surfaces

### Post-Processing Tools
Recommended tools for visualization and analysis:

- **Paraview**  - For visualizing VTK output
- **GNU Octave** ‚Äì For additional post-processing, e.g., .octbin data files.

## Quick Start Options
###  üèÉ‚Äç‚ôÇÔ∏è Very Impatient: Use Precompiled Apptainer Image
Precompiled NextGenPB container images are available with OpenMPI 4 or 5.

**Requirements**: Apptainer (or Singularity)

**Download**:
```bash
wget ....
```
**Example command**:
```bash
 apptainer exec --pwd /App --bind /path/to/files/:/App  /path/to/sif/NextGenPB_ompi4.sif mpirun -np <number_of_processors> ngpb --prmfile options.prm
```
### üö∂‚Äç‚ôÇÔ∏è Less Impatient: Build Docker or Apprainer Image
If you have root permissions, you can build the Docker or Apprainer image. This approach allows customization of library versions and compiler flags (e.g., CFLAGS="-O3 -mtune=native -march=native").

To build the Docker image:
```bash
sudo docker build -f Dockerfile -t <name_of_image>:latest .
```
To run the Docker image:
```bash
sudo docker run -v "$(pwd)":/App -w /App <name_of_image>:latest mpirun -np <number_of_processors> ngpb --prmfile options.prm
```

To build the Apptainer image :
```bash
sudo apptainer build NextGenPB_ompi4.sif recipe.def
```
To run the Apptainer image:
```bash
 apptainer exec --pwd /App --bind /path/to/files/:/App  /path/to/sif/NextGenPB_ompi4.sif mpirun -np <number_of_processors> ngpb --prmfile options.prm
```

## üçè Installation on macOS (via MacPorts)

This section describes step-by-step how to build NextGenPB from source on macOS using MacPorts. (It is possible the same using Homebrew)

### ‚úÖ Step 1: Install Prerequisites

Install all required packages:

```bash
sudo port install openmpi cmake onetbb boost cgal5 nlohmann-json jansson octave
sudo port install mumps +openmpi -mpich
sudo port install lis +openmpi -mpich
sudo port install p4est +openmpi -mpich
```

### ‚úÖ Step 2: Install External Libraries

**`NanoShaper`**
NanoShaper is required to compute molecular surfaces.
```bash
git clone https://gitlab.iit.it/SDecherchi/nanoshaper.git
cd nanoshaper
cp CMakeLists_so.txt CMakeLists.txt
cd build_lib
cmake .. -DCGAL_DIR=/opt/local/ -DCMAKE_BUILD_TYPE=Release
make
```

**`octave_file_io`**
Needed to interface with .octbin files generated by GNU Octave.

```bash
git clone https://github.com/carlodefalco/octave_file_io.git
cd octave_file_io
./autogen.sh
mkdir build
cd build
../configure CXX=mpicxx --prefix=/opt/octave_file_io/1.0.91 --with-octave-home=/opt/local/bin 'LDFLAGS=-Wl,-rpath -Wl,/opt/local/lib/libgcc -Wl,-rpath -Wl,/opt/local/lib/gcc13 -ld_classic'
make
sudo make install
```

**`bim++` (with NextGenPB Branch)**
Clone and build the bim++ library:
wget https://github.com/carlodefalco/bimpp/archive/refs/tags/NextGenPB-v0.0.01.tar.gz && \
        tar -xvzf NextGenPB-v0.0.01.tar.gz && rm -rf  NextGenPB-v0.0.01.tar.gz && \
        cd bimpp-NextGenPB-v0.0.01 && ./autogen.sh && mkdir build && cd build && \

```bash
wget https://github.com/carlodefalco/bimpp/archive/refs/tags/NextGenPB-v0.0.01.tar.gz && \
        tar -xvzf NextGenPB-v0.0.01.tar.gz && rm -rf  NextGenPB-v0.0.01.tar.gz && \
        cd bimpp-NextGenPB-v0.0.01 && ./autogen.sh && mkdir build && cd build
../configure --prefix=/opt/bimpp --disable-option-checking \
LDFLAGS="-L/opt/local/lib -Wl,-rpath,/opt/local/lib/libgcc -Wl,-rpath,/opt/local/lib/gcc14" \
CPPFLAGS="-I/opt/local/include/ -I/opt/local/include/gcc14 -DOMPI_SKIP_MPICXX -DHAVE_OCTAVE_44 -DBIM_TIMING" \
 --with-blas-lapack="-lopenblas"  \
 --with-octave_file_io-home=/opt/octave_file_io/1.0.91 \
 --with-octave-home=/opt/local/bin \
 --with-p4est-home=/opt/local \
 --with-lis-home=/opt/local \
 --with-mumps-home=/opt/local \
 F77=mpif90 CXX=mpicxx MPICC=mpicc CC=mpicc \
CXXFLAGS="-std=c++17 -O3 -mtune=native -march=native" \
--with-mumps-extra-libs="-L/opt/local/lib -lptscotch -lscotch -lmpi -Wl,-flat_namespace -Wl,-commons,use_dylibs \
-L/opt/local/lib/openmpi-mp -lmpi_usempif08 -lmpi_usempi_ignore_tkr -lmpi_mpifh -lopenblas -L/opt/local/lib/gcc14 -lgfortran"

make
sudo make install
```

### ‚úÖ Step 3: Compile NextGenPB
####  Prepare Build Settings
Copy the appropriate local_settings.mk file from the local_setting/ directory:
```bash
cp local_setting/local_settings_mac.mk src/local_settings.mk
```
Edit this file as needed for macOS-specific paths and compiler flags.

####  Build Executable
From the src directory:

```bash
make clean all
```
This process generates an executable named `ngpb` in the `src` directory.

### ‚úÖ Step 4: Add to PATH (Optional)
To run ngpb from anywhere, add it to your terminal path. For example, in .zshrc:
```bash
export PATH=/path/to/exec:$PATH
```
Then reload the shell:
```bash
source ~/.zshrc
```

## üêß Installation on Rocky Linux and Ubuntu

If you‚Äôre using Rocky Linux or Ubuntu, follow the respective Dockerfile provided:
- Dockerfile ‚Äì for Rocky Linux
- Dockerfile_ubuntu ‚Äì for Ubuntu

If building directly on your system, ensure consistent compilation flags across all dependencies:
```bash
export CXXFLAGS="-O3 -mtune=native -march=native"
export CFLAGS="-O3 -mtune=native -march=native"
export FCFLAGS="-O3 -mtune=native -march=native"
```
Use these when compiling libraries like MUMPS, LIS, and bim++, and while building NextGenPB.

